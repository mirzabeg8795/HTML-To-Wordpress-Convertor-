<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML to WordPress Theme Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js"></script>
    <style>
        .code-block { background-color: #f5f5f5; padding: 1rem; border-radius: 0.5rem; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-tab.active { border-color: #3b82f6; color: #2563eb; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- UI remains the same until the script section -->
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        class ThemeConverter {
            constructor() {
                this.zip = new JSZip();
                this.files = {};
                this.assets = { css: [], js: [], images: [] };
                this.initEventListeners();
                this.initTabs();
            }

            // ... [Keep previous methods until getThemeData] ...

            getThemeData() {
                const name = document.getElementById('theme-name').value.trim() || 'Custom Theme';
                
                // Generate valid slug and function prefix
                let slug = name.toLowerCase()
                    .replace(/\s+/g, '-')
                    .replace(/[^a-z0-9-]/g, '')
                    .replace(/^-+|-+$/g, '');

                let functionPrefix = slug.replace(/-/g, '_')
                    .replace(/[^a-z0-9_]/g, '')
                    .replace(/^[0-9]+/, '');

                if (!functionPrefix) {
                    functionPrefix = 'custom_theme';
                    slug = 'custom-theme';
                }

                return {
                    name: name,
                    slug: slug,
                    functionPrefix: functionPrefix,
                    uri: document.getElementById('theme-uri').value.trim(),
                    author: document.getElementById('theme-author').value.trim(),
                    author_uri: document.getElementById('theme-author-uri').value.trim(),
                    description: document.getElementById('theme-description').value.trim()
                };
            }

            sanitizeHTML(html) {
                // Remove PHP tags and sanitize
                const clean = html.replace(/<\?[\s\S]*?\?>/g, '');
                return DOMPurify.sanitize(clean);
            }

            generateHeader(doc, themeData) {
                const headerContent = doc.querySelector('header')?.outerHTML || '<header><!-- Default header --></header>';
                return `<?php
/**
 * Header template for ${themeData.name}
 */
if (!defined('ABSPATH')) exit; ?>
<!DOCTYPE html>
<html <?php language_attributes(); ?>>
<head>
    <meta charset="<?php bloginfo('charset'); ?>">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <?php wp_head(); ?>
</head>
<body <?php body_class(); ?>>
${headerContent}`;
            }

            generateFunctions(themeData) {
                return `<?php
/**
 * Functions file for ${themeData.name}
 */
if (!defined('ABSPATH')) exit;

function ${themeData.functionPrefix}_setup() {
    add_theme_support('title-tag');
    add_theme_support('post-thumbnails');
    add_theme_support('wp-block-styles');
    add_theme_support('align-wide');
    
    register_nav_menus([
        'primary' => __('Primary Menu', '${themeData.slug}'),
        'footer' => __('Footer Menu', '${themeData.slug}')
    ]);
    
    register_sidebar([
        'name' => __('Main Sidebar', '${themeData.slug}'),
        'id' => 'sidebar-1'
    ]);
}
add_action('after_setup_theme', '${themeData.functionPrefix}_setup');

function ${themeData.functionPrefix}_scripts() {
    wp_enqueue_style('${themeData.slug}-style', get_stylesheet_uri());
}
add_action('wp_enqueue_scripts', '${themeData.functionPrefix}_scripts');`;
            }

            async downloadTheme() {
                try {
                    const themeData = this.getThemeData();
                    if (!Object.keys(this.files).length) throw new Error('Generate theme first');
                    
                    const themeFolder = this.zip.folder(themeData.slug);
                    
                    // Add core files
                    Object.entries(this.files).forEach(([name, content]) => {
                        themeFolder.file(name, content);
                    });
                    
                    // Add required WordPress files
                    themeFolder.file('index.php', this.files['index.php']);
                    themeFolder.file('style.css', this.files['style.css']);
                    themeFolder.file('functions.php', this.files['functions.php']);
                    themeFolder.file('header.php', this.files['header.php']);
                    themeFolder.file('footer.php', this.files['footer.php']);
                    
                    // Create assets directories
                    ['css', 'js', 'images'].forEach(dir => {
                        themeFolder.folder(`assets/${dir}`);
                    });

                    const content = await themeFolder.generateAsync({ type: "blob" });
                    this.triggerDownload(content, `${themeData.slug}.zip`);
                    
                } catch (error) {
                    this.handleError(error);
                }
            }

            // ... [Keep other methods with similar fixes] ...
        }

        new ThemeConverter();
    });
    </script>
</body>
</html>
